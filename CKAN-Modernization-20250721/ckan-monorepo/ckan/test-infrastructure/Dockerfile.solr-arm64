FROM --platform=linux/arm64 solr:8-slim

# Switch to root to install dependencies and configure
USER root

# Install curl for health checks
RUN apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*

# Create the CKAN core directory
RUN mkdir -p /var/solr/data/ckan/conf

# Copy CKAN-specific schema files
COPY ckan-schema/ /tmp/ckan-schema/

# Create CKAN core and configure schema
RUN solr-precreate ckan /tmp/ckan-schema/

# Set proper ownership
RUN chown -R solr:solr /var/solr/data

# Health check
HEALTHCHECK --interval=30s --timeout=10s --retries=3 \
  CMD curl -f http://localhost:8983/solr/ckan/admin/ping || exit 1

# Switch back to solr user
USER solr

EXPOSE 8983
